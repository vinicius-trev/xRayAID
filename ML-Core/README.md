# ML-CORE
Major of the work stored in this subfolder was reutilize from the [RSNA 11th Place Solution GitHub](https://github.com/erniechiew/kaggle_rsna_pneumonia_dancingbears).
The code was slightly modifies to fit out needs.


## Overview
The solution consists of a DenseNet-121 image classification model, that predicts the percentage of a chest X-ray indicate a positive for pneumonia. The final score is generated by ensembling predictions from 5-fold cross-validation. Each fold takes approximately 1 day to train on a single NVIDIA GeForce RTX 2070 GPU. The model was build using Keras with TensorFlow backend.

## Hardware Used
* Intel Core i7-3930k, 6 Cores 12 Threads
* 32 GB 1600MhZ RAM
* 1 x NVIDIA GeForce RTX 2070

## Platform and Software
* Ubuntu 18.04 LTS
* Python 3.5.4
* CUDA 9.0
* cuDNN 7.0

## Important Note
The training and inference steps will overwrite any existing weights and test set predictions.

## Data
Data should be obtained from the RSNA Pneumonia Detection Challenge page on Kaggle and placed in the `~/Dataset` directory, as explained in that subfolder.

## Preprocessing

### Convert DCM to PNG
In the `~/Dataset/utils` directory, run the example notebooks to convert the DICOM images to PNG

### Generate 5-fold CV splits (Optional)
We provide the splits we used for our final submission in `training_splits/`. **For the purposes of reproducing our solution on the leaderboard, please use provided splits**. If you wish to generate new splits (and overwrite the provided splits), in the `preprocessing` directory, run
```
python train_split_generator.py
```
Generated splits will be stored in `training_splits/` folder (and will overwrite any existing splits).

## Training

### Settings
Change the `SETTINGS.json` file according to your paths and preferences 

### Classification Model

In the `classification` directory, run
```
python classifier_train.py
```
Resulting model weights will be stored in `classification/weights/` folder. Modify `SPLIT_NUMBER` (manually within the `classifier_train.py` file for now -- sorry) to train the model for each of the 5 splits. After this step, the `classification/weights/` folder should contain the trained weights from each of the five folds.


## Inference

### Classification Model

In the `classification` directory to predict only the percentages, run
```bash
python classifier_predict.py
```

To predict the percentages with heatmap, run
```bash
python classifier_predict_heatmap.py
```

Resulting predictions on test set will be stored in `classification/results/` folder. Again, modify `SPLIT_NUMBER` in `classifier_predict.py` to train the model for each of the 5 splits. After this step, the `classification/results/` folder should contain the classifier's predictions on the test set for each of the 5 folds.


## Utils

The TF 1.8.0 trained model does not work with the recent version 2.3.0, that said, use the `convert_original_models.py`, specifying the desired `SPLIT_NUMBER` to keep the compatibility.

## Acknowledgements
The code from the followed repository was used as based:

https://github.com/erniechiew/kaggle_rsna_pneumonia_dancingbears